<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated Title -->
    <title>Veil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Code+Pro:wght@400;500&display=swap');
        
        /* Updated Color Theme */
        :root {
            --bg-primary: #0C0C0C; /* Jet black */
            --bg-secondary: #181818; /* Matte dark gray */
            --accent: #7A3E9D; /* Dark violet glow */
            --text-primary: #ECECEC; /* Off-white */
            --text-secondary: #a0a0a0; /* Lighter gray */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        .card-bg {
            background-color: var(--bg-secondary);
            border: 1px solid #2a2a2a;
        }

        .input-field {
            font-family: 'Inter', sans-serif;
            background-color: #2a2a2a;
            color: var(--text-primary);
            border: 1px solid #4a4a4a;
            transition: all 0.2s ease-in-out;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(122, 62, 157, 0.5);
        }
        
        .btn {
            transition: all 0.2s ease-in-out;
        }
        
        .btn-primary {
            background-color: var(--accent);
            color: var(--text-primary);
        }
        .btn-primary:hover {
            opacity: 0.85;
        }
        
        .btn-secondary {
            background-color: #3a3a3a;
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background-color: #4a4a4a;
        }

        .btn-danger {
            background-color: #9d3e3e; /* Dark red */
            color: var(--text-primary);
        }
        .btn-danger:hover {
            background-color: #b94e4e;
        }

        .chat-textarea {
            font-family: 'Source Code Pro', monospace;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid #2a2a2a;
            caret-color: var(--accent);
            transition: all 0.1s ease-in-out;
            resize: none;
        }

        .chat-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(122, 62, 157, 0.5);
        }

        .chat-textarea-readonly {
            background-color: #111; /* Slightly darker than secondary */
            color: #a0a0a0;
        }

        /* Status Dot */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            transition: background-color 0.3s ease;
        }
        .status-online { background-color: #34D399; } /* Emerald-400 */
        .status-offline { background-color: #6B7280; } /* Gray-500 */

        /* Recent Chat Item */
        .recent-chat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            background-color: #2a2a2a;
            transition: background-color 0.2s ease;
        }
        .recent-chat-item:hover {
            background-color: #3a3a3a;
        }
    </style>
</head>
<body class="h-full flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">
        
        <!-- Loading Screen -->
        <div id="loading-screen" class.list="flex flex-col items-center justify-center h-full">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg text-text-secondary">Connecting to Veil...</p>
        </div>

        <!-- Login/Signup Screen -->
        <div id="auth-screen" class="hidden w-full max-w-md mx-auto">
            <div class="card-bg p-8 rounded-lg shadow-2xl">
                <!-- Updated Heading -->
                <h2 class="text-3xl font-bold text-center text-white mb-8">Veil</h2>
                
                <!-- Sign Up Form -->
                <form id="signup-form" class="space-y-4">
                    <h3 class="text-xl font-semibold text-white">Create an Account</h3>
                    <div>
                        <label for="signup-username" class="block text-sm font-medium text-text-secondary">Username</label>
                        <input type="text" id="signup-username" class="input-field w-full p-3 mt-1 rounded-md" required>
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-text-secondary">Password</label>
                        <input type="password" id="signup-password" class="input-field w-full p-3 mt-1 rounded-md" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full py-3 rounded-md font-semibold">Sign Up</button>
                    <p id="signup-error" class="text-red-400 text-sm text-center"></p>
                </form>

                <!-- Login Form (Initially hidden) -->
                <form id="login-form" class="hidden space-y-4">
                    <h3 class="text-xl font-semibold text-white">Log In</h3>
                    <div>
                        <label for="login-username" class="block text-sm font-medium text-text-secondary">Username</label>
                        <input type="text" id="login-username" class="input-field w-full p-3 mt-1 rounded-md" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-text-secondary">Password</label>
                        <input type="password" id="login-password" class="input-field w-full p-3 mt-1 rounded-md" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full py-3 rounded-md font-semibold">Log In</button>
                    <p id="login-error" class="text-red-400 text-sm text-center"></p>
                </form>

                <p class="text-center text-sm text-text-secondary mt-6">
                    <span id="auth-toggle-text">Already have an account?</span>
                    <a href="#" id="auth-toggle-link" class="font-medium text-accent hover:underline">Log In</a>
                </p>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="hidden w-full max-w-lg mx-auto">
            <div class="card-bg p-8 rounded-lg shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Welcome, <span id="dash-username" class="text-accent"></span></h2>
                    <button id="logout-btn" class="btn btn-secondary px-4 py-2 rounded-md font-semibold">Logout</button>
                </div>
                
                <div class="bg-gray-800 p-4 rounded-lg mb-6">
                    <p class="text-sm text-text-secondary">Your Unique Code (share this with friends):</p>
                    <p id="dash-unique-code" class="text-lg font-mono text-yellow-400 cursor-pointer" title="Click to copy"></p>
                </div>

                <div class="space-y-4">
                    <label for="search-username" class="block text-sm font-medium text-text-secondary">Search for a user to chat with</label>
                    <div class="flex space-x-2">
                        <input type="text" id="search-username" class="input-field w-full p-3 rounded-md" placeholder="Enter exact username...">
                        <button id="search-btn" class="btn btn-primary px-5 py-3 rounded-md font-semibold">Search</button>
                    </div>
                    <div id="search-results" class="mt-4"></div>
                </div>

                <!-- Recent Chats -->
                <div class="mt-8">
                    <h3 class="text-xl font-semibold text-white mb-4">Recent Chats</h3>
                    <div id="recent-chats-list" class="space-y-3">
                        <p class="text-text-secondary">No recent chats.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Screen (NEW Two-Pad Layout) -->
        <div id="chat-screen" class="hidden h-[80vh] flex flex-col">
             <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-xl font-bold text-white">Chat with <span id="recipient-display"></span></h2>
                    <p class="text-sm text-text-secondary">You are <span id="user-display" class="text-accent"></span></p>
                    <div id="online-status-container" class="flex items-center">
                        <span id="online-status-dot" class="status-dot status-offline"></span>
                        <span id="online-status-text" class="text-sm text-text-secondary">Offline</span>
                    </div>
                </div>
                <div>
                    <button id="clear-btn" class="btn btn-secondary px-4 py-2 rounded-md font-semibold mr-2">Clear My Pad</button>
                    <button id="leave-btn" class="btn btn-danger px-4 py-2 rounded-md font-semibold">Leave</button>
                </div>
             </div>
             
             <!-- Two-Pad Layout -->
             <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Your Pad -->
                <div class="flex flex-col">
                    <label for="my-chat-pad" class="text-sm font-medium text-text-secondary mb-2">Your Pad (Start typing...)</label>
                    <textarea id="my-chat-pad" class="chat-textarea w-full flex-grow p-4 rounded-lg text-lg leading-7" spellcheck="false"></textarea>
                </div>
                
                <!-- Their Pad -->
                <div class="flex flex-col">
                    <label for="their-chat-pad" class="text-sm font-medium text-text-secondary mb-2">Their Pad</label>
                    <textarea id="their-chat-pad" class="chat-textarea chat-textarea-readonly w-full flex-grow p-4 rounded-lg text-lg leading-7" readonly></textarea>
                </div>
             </div>
        </div>

    </div>

    <!-- Custom Code Prompt Modal -->
    <div id="code-prompt-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="card-bg p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-semibold text-white mb-2">Enter Unique Code</h2>
            <p class="text-text-secondary mb-4">To start a secure chat with <strong id="prompt-recipient-name" class="text-accent"></strong>, please enter their code.</p>
            <div class="space-y-4">
                <div>
                    <label for="code-prompt-input" class="block text-sm font-medium text-gray-300">Unique Code</label>
                    <input type="text" id="code-prompt-input" class="input-field w-full p-2 mt-1 rounded-md" placeholder="e.g., alpha-1234">
                </div>
                <div id="code-prompt-error" class="text-red-400 text-sm text-center h-4"></div>
                <div class="flex justify-end space-x-3 mt-2">
                    <button id="code-prompt-cancel" class="btn btn-secondary px-4 py-2 rounded-md font-semibold">Cancel</button>
                    <button id="code-prompt-confirm" class="btn btn-primary px-4 py-2 rounded-md font-semibold">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            deleteDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config (Pasted from user) ---
        const firebaseConfig = {
          apiKey: "AIzaSyAO6sKjbBKdWm3MXggc-Iliywxh7CwSKok",
          authDomain: "capsc-d160e.firebaseapp.com",
          projectId: "capsc-d160e",
          storageBucket: "capsc-d160e.firebasestorage.app",
          messagingSenderId: "1069210585933",
          appId: "1:1069210585933:web:54f05cf195caeea8320504",
          measurementId: "G-4957PFGHS2"
        };

        // --- App ID (for Firestore path) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- App State ---
        let db, auth, currentUser, currentRoomId, cryptoKey;
        let unsubscribeRoom = () => {};
        let unsubscribePresence = () => {};
        let isUpdatingFromFirestore = false;

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const chatScreen = document.getElementById('chat-screen');
        
        // Auth
        const signupForm = document.getElementById('signup-form');
        const loginForm = document.getElementById('login-form');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authToggleText = document.getElementById('auth-toggle-text');
        const signupError = document.getElementById('signup-error');
        const loginError = document.getElementById('login-error');
        
        // Dashboard
        const dashUsername = document.getElementById('dash-username');
        const dashUniqueCode = document.getElementById('dash-unique-code');
        const logoutBtn = document.getElementById('logout-btn');
        const searchBtn = document.getElementById('search-btn');
        const searchInput = document.getElementById('search-username');
        const searchResults = document.getElementById('search-results');
        const recentChatsList = document.getElementById('recent-chats-list');
        
        // Chat
        const recipientDisplay = document.getElementById('recipient-display');
        const userDisplay = document.getElementById('user-display');
        const myChatPad = document.getElementById('my-chat-pad');
        const theirChatPad = document.getElementById('their-chat-pad');
        const clearBtn = document.getElementById('clear-btn');
        const leaveBtn = document.getElementById('leave-btn');
        const onlineStatusDot = document.getElementById('online-status-dot');
        const onlineStatusText = document.getElementById('online-status-text');
        
        // Modal
        const codePromptModal = document.getElementById('code-prompt-modal');
        const codePromptRecipientName = document.getElementById('prompt-recipient-name');
        const codePromptInput = document.getElementById('code-prompt-input');
        const codePromptError = document.getElementById('code-prompt-error');
        const codePromptCancel = document.getElementById('code-prompt-cancel');
        const codePromptConfirm = document.getElementById('code-prompt-confirm');


        // --- Init ---
        async function init() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Auth state listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    await loadUserData(user.uid);
                    showDashboard();
                } else {
                    // User is signed out
                    currentUser = null;
                    showAuthScreen();
                }
            });

            setupEventListeners();
        }

        // --- Auth & User Functions ---

        async function loadUserData(uid) {
            const userRef = doc(db, `/artifacts/${appId}/public/data/users`, uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                currentUser = { uid, ...userSnap.data() };
                dashUsername.textContent = currentUser.username;
                dashUniqueCode.textContent = currentUser.uniqueCode;
            } else {
                console.error("No user data found for logged-in user!");
                await signOut(auth);
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const username = signupForm.querySelector('#signup-username').value.trim();
            const password = signupForm.querySelector('#signup-password').value.trim();
            signupError.textContent = '';
            
            if (username.length < 3) {
                signupError.textContent = 'Username must be at least 3 characters.';
                return;
            }

            // 1. Check if username is taken
            const userQuery = query(collection(db, `/artifacts/${appId}/public/data/users`), where("username", "==", username));
            const querySnap = await getDocs(userQuery);
            if (!querySnap.empty) {
                signupError.textContent = 'Username is already taken.';
                return;
            }

            // 2. Create auth user
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, `${username}@e2ee-chat.app`, password);
                const user = userCredential.user;

                // 3. Create user profile in Firestore
                const uniqueCode = `${Math.random().toString(36).substr(2, 5)}-${Math.floor(1000 + Math.random() * 9000)}`;
                const userRef = doc(db, `/artifacts/${appId}/public/data/users`, user.uid);
                await setDoc(userRef, {
                    username: username,
                    uid: user.uid,
                    uniqueCode: uniqueCode
                });

                // App will auto-login via onAuthStateChanged
            } catch (error) {
                console.error("Signup error:", error);
                signupError.textContent = error.message.replace('Firebase: ', '');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = loginForm.querySelector('#login-username').value.trim();
            const password = loginForm.querySelector('#login-password').value.trim();
            loginError.textContent = '';
            
            try {
                await signInWithEmailAndPassword(auth, `${username}@e2ee-chat.app`, password);
                // App will auto-login via onAuthStateChanged
            } catch (error) {
                console.error("Login error:", error);
                loginError.textContent = 'Invalid username or password.';
            }
        }

        function toggleAuthForms() {
            const isLogin = loginForm.classList.contains('hidden');
            if (isLogin) {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                authToggleText.textContent = "Don't have an account?";
                authToggleLink.textContent = 'Sign Up';
            } else {
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
                authToggleText.textContent = 'Already have an account?';
                authToggleLink.textContent = 'Log In';
            }
        }

        // --- UI Navigation ---
        
        function showLoadingScreen() {
            loadingScreen.classList.remove('hidden');
            authScreen.classList.add('hidden');
            dashboardScreen.classList.add('hidden');
            chatScreen.classList.add('hidden');
        }

        function showAuthScreen() {
            loadingScreen.classList.add('hidden');
            authScreen.classList.remove('hidden');
            dashboardScreen.classList.add('hidden');
            chatScreen.classList.add('hidden');
        }
        
        function showDashboard() {
            loadingScreen.classList.add('hidden');
            authScreen.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');
            chatScreen.classList.add('hidden');
            displayRecentChats();
        }
        
        function showChatScreen(username, recipientUsername) {
            loadingScreen.classList.add('hidden');
            authScreen.classList.add('hidden');
            dashboardScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            
            userDisplay.textContent = username;
            recipientDisplay.textContent = recipientUsername;
            
            // Reset pads
            myChatPad.value = '';
            theirChatPad.value = '';
            myChatPad.focus();
        }

        // --- Custom Modal Prompt ---
        function showCodePrompt(recipient) {
            return new Promise((resolve, reject) => {
                codePromptRecipientName.textContent = recipient.username;
                codePromptInput.value = '';
                codePromptError.textContent = '';
                codePromptModal.classList.remove('hidden');
                codePromptInput.focus();

                const handleConfirm = () => {
                    const code = codePromptInput.value.trim();
                    if (!code) {
                        codePromptError.textContent = 'Please enter a code.';
                        return;
                    }
                    cleanup();
                    resolve(code);
                };

                const handleCancel = () => {
                    cleanup();
                    reject(new Error('User cancelled prompt.'));
                };

                const handleKeyup = (e) => {
                    if (e.key === 'Enter') handleConfirm();
                    if (e.key === 'Escape') handleCancel();
                };

                codePromptConfirm.addEventListener('click', handleConfirm);
                codePromptCancel.addEventListener('click', handleCancel);
                codePromptInput.addEventListener('keyup', handleKeyup);
                
                function cleanup() {
                    codePromptConfirm.removeEventListener('click', handleConfirm);
                    codePromptCancel.removeEventListener('click', handleCancel);
                    codePromptInput.removeEventListener('keyup', handleKeyup);
                    codePromptModal.classList.add('hidden');
                }
            });
        }

        // --- Crypto Helper Functions ---
        
        async function deriveKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                "PBKDF2",
                false,
                ["deriveKey"]
            );
            return crypto.subtle.deriveKey(
                {
                    "name": "PBKDF2",
                    salt: enc.encode(salt),
                    iterations: 100000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { "name": "AES-GCM", "length": 256 },
                true,
                ["encrypt", "decrypt"]
            );
        }

        async function encryptText(text, key) {
            const enc = new TextEncoder();
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                key,
                enc.encode(text)
            );
            
            const ivString = btoa(String.fromCharCode.apply(null, iv));
            const encryptedString = btoa(String.fromCharCode.apply(null, new Uint8Array(encrypted)));
            
            return `${ivString}:${encryptedString}`;
        }

        async function decryptText(encryptedString, key) {
            try {
                const [ivString, encryptedData] = encryptedString.split(':');
                if (!ivString || !encryptedData) {
                    return "DECRYPTION FAILED: Invalid data format.";
                }
                
                const iv = new Uint8Array(atob(ivString).split('').map(c => c.charCodeAt(0)));
                const data = new Uint8Array(atob(encryptedData).split('').map(c => c.charCodeAt(0)));
                
                const decrypted = await crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    data
                );
                
                const dec = new TextDecoder();
                return dec.decode(decrypted);
            } catch (error) {
                console.error("Decryption error:", error);
                return "DECRYPTION FAILED: Invalid unique code for this user.";
            }
        }

        // --- Dashboard & Search ---
        
        async function handleSearch() {
            const username = searchInput.value.trim();
            searchResults.innerHTML = '';
            if (username === currentUser.username) {
                searchResults.innerHTML = `<p class="text-yellow-400">You can't chat with yourself.</p>`;
                return;
            }

            const userQuery = query(collection(db, `/artifacts/${appId}/public/data/users`), where("username", "==", username));
            const querySnap = await getDocs(userQuery);
            
            if (querySnap.empty) {
                searchResults.innerHTML = `<p class="text-red-400">User not found.</p>`;
            } else {
                const recipient = querySnap.docs[0].data();
                searchResults.innerHTML = `
                    <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                        <span class="text-white">${recipient.username}</span>
                        <button id="start-chat-btn" class="btn btn-primary px-4 py-2 rounded-md">Chat</button>
                    </div>
                `;
                document.getElementById('start-chat-btn').addEventListener('click', () => handleInitiateChat(recipient));
            }
        }

        async function handleInitiateChat(recipient, optionalSecret = null) {
            let secret = optionalSecret;
            searchResults.innerHTML = '';

            if (!secret) {
                try {
                    secret = await showCodePrompt(recipient);
                } catch (error) {
                    searchResults.innerHTML = `<p class="text-red-400">Chat cancelled.</p>`;
                    return;
                }
            }

            const usernames = [currentUser.username, recipient.username].sort();
            const roomId = usernames.join('-');

            try {
                cryptoKey = await deriveKey(secret, roomId);
                currentRoomId = roomId;

                // Test decryption to see if key is valid
                const testRoomRef = doc(db, `/artifacts/${appId}/public/data/e2ee-chat`, currentRoomId);
                const docSnap = await getDoc(testRoomRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const otherUserKey = recipient.uid === currentUser.uid ? currentUser.uid : recipient.uid;
                    if(data[otherUserKey]) {
                        await decryptText(data[otherUserKey], cryptoKey);
                    }
                }
                
                saveRecentChat(recipient, secret);
                listenToRoom();
                showChatScreen(currentUser.username, recipient.username);

            } catch (error) {
                console.error("Error starting chat:", error);
                if (optionalSecret) {
                    searchResults.innerHTML = `<p class="text-red-400">The saved code for this user is incorrect. It's been removed. Please search for them again.</p>`;
                    deleteRecentChat(recipient.uid);
                } else {
                    searchResults.innerHTML = `<p class="text-red-400">Could not start chat. The code you entered is incorrect.</p>`;
                }
            }
        }

        // --- Recent Chats Functions ---
        
        function getRecentChats() {
            try {
                const chats = localStorage.getItem('recentChats');
                return chats ? JSON.parse(chats) : [];
            } catch (e) {
                return [];
            }
        }

        function saveRecentChat(recipient, secret) {
            let chats = getRecentChats();
            // Remove existing entry if it exists
            chats = chats.filter(chat => chat.uid !== recipient.uid);
            // Add to the top
            chats.unshift({ uid: recipient.uid, username: recipient.username, secret: secret });
            // Keep only last 5
            chats = chats.slice(0, 5);
            localStorage.setItem('recentChats', JSON.stringify(chats));
        }
        
        function deleteRecentChat(uid) {
            let chats = getRecentChats();
            chats = chats.filter(chat => chat.uid !== uid);
            localStorage.setItem('recentChats', JSON.stringify(chats));
            displayRecentChats();
        }

        function displayRecentChats() {
            const chats = getRecentChats();
            if (chats.length === 0) {
                recentChatsList.innerHTML = `<p class="text-text-secondary">No recent chats.</p>`;
                return;
            }
            
            recentChatsList.innerHTML = '';
            chats.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'recent-chat-item';
                item.innerHTML = `
                    <span class="text-white font-medium">${chat.username}</span>
                    <button class="btn btn-primary px-4 py-2 rounded-md text-sm">Chat</button>
                `;
                item.querySelector('button').addEventListener('click', () => {
                    handleInitiateChat(chat, chat.secret);
                });
                recentChatsList.appendChild(item);
            });
        }

        // --- Chat Room Functions ---

        async function updateFirestoreContent(content) {
            if (isUpdatingFromFirestore || !cryptoKey || !currentRoomId) return;
            
            const encryptedContent = await encryptText(content, cryptoKey);
            const roomRef = doc(db, `/artifacts/${appId}/public/data/e2ee-chat`, currentRoomId);
            
            // Update only our part of the document
            await setDoc(roomRef, {
                [currentUser.uid]: encryptedContent 
            }, { merge: true });
        }

        function listenToRoom() {
            const roomRef = doc(db, `/artifacts/${appId}/public/data/e2ee-chat`, currentRoomId);
            unsubscribeRoom = onSnapshot(roomRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let theirContent = '';
                    
                    // Find the key that is NOT our own
                    const otherUserKey = Object.keys(data).find(key => key !== currentUser.uid);
                    
                    if (otherUserKey && data[otherUserKey]) {
                        theirContent = await decryptText(data[otherUserKey], cryptoKey);
                    }
                    
                    isUpdatingFromFirestore = true;
                    if (theirChatPad.value !== theirContent) {
                        theirChatPad.value = theirContent;
                    }
                    isUpdatingFromFirestore = false;
                }
            });

            // --- Presence ---
            const presenceRef = doc(db, `/artifacts/${appId}/public/data/presence/${currentRoomId}/users`, currentUser.uid);
            setDoc(presenceRef, { online: true });
            
            const recipientQuery = query(collection(db, `/artifacts/${appId}/public/data/presence/${currentRoomId}/users`));
            unsubscribePresence = onSnapshot(recipientQuery, (snapshot) => {
                let isOnline = false;
                snapshot.forEach((doc) => {
                    if (doc.id !== currentUser.uid && doc.data().online) {
                        isOnline = true;
                    }
                });
                
                if (isOnline) {
                    onlineStatusDot.classList.replace('status-offline', 'status-online');
                    onlineStatusText.textContent = 'Online';
                } else {
                    onlineStatusDot.classList.replace('status-online', 'status-offline');
                    onlineStatusText.textContent = 'Offline';
                }
            });
        }

        async function handleLeave() {
            unsubscribeRoom();
            unsubscribePresence();
            
            // Set self to offline
            const presenceRef = doc(db, `/artifacts/${appId}/public/data/presence/${currentRoomId}/users`, currentUser.uid);
            await setDoc(presenceRef, { online: false });

            // Delete the entire chat document
            const roomRef = doc(db, `/artifacts/${appId}/public/data/e2ee-chat`, currentRoomId);
            await deleteDoc(roomRef);

            cryptoKey = null;
            currentRoomId = null;
            
            showDashboard();
        }
        
        async function handleClear() {
            // Only clears our own pad and syncs it
            myChatPad.value = '';
            await updateFirestoreContent('');
        }

        // --- Global Event Listeners ---
        function setupEventListeners() {
            signupForm.addEventListener('submit', handleSignup);
            loginForm.addEventListener('submit', handleLogin);
            authToggleLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForms();
            });
            
            logoutBtn.addEventListener('click', () => signOut(auth));
            searchBtn.addEventListener('click', handleSearch);
            searchInput.addEventListener('keyup', (e) => e.key === 'Enter' && handleSearch());
            
            dashUniqueCode.addEventListener('click', () => {
                navigator.clipboard.writeText(dashUniqueCode.textContent);
                // Simple feedback
                const oldText = dashUniqueCode.textContent;
                dashUniqueCode.textContent = 'Copied!';
                setTimeout(() => { dashUniqueCode.textContent = oldText; }, 1000);
            });
            
            leaveBtn.addEventListener('click', handleLeave);
            clearBtn.addEventListener('click', handleClear);

            myChatPad.addEventListener('input', () => {
                updateFirestoreContent(myChatPad.value);
            });
        }

        // --- Start App ---
        init();

    </script>
</body>
</html>

