<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Source+Code+Pro:wght@400;500&display=swap');
        
        /* New Color Theme */
        :root {
            --primary: #0C0C0C;
            --secondary: #181818;
            --accent: #7A3E9D;
            --text: #ECECEC;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary); /* Jet black */
            color: var(--text); /* Off-white */
        }
        .chat-textarea {
            font-family: 'Source Code Pro', monospace;
            background-color: var(--secondary); /* Matte dark gray */
            color: var(--text);
            border-color: #4b5563; /* Keep a subtle border */
            caret-color: var(--accent); /* Dark violet glow */
            transition: all 0.2s ease-in-out;
        }
        .chat-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--secondary), 0 0 0 4px var(--accent);
        }
        .btn {
            transition: all 0.2s ease-in-out;
            border-radius: 0.375rem; /* rounded-md */
        }
        .btn-primary {
            background-color: var(--accent);
            color: var(--text);
        }
        .btn-primary:hover {
            opacity: 0.85;
        }
        .btn-secondary {
            background-color: #374151; /* A bit lighter than secondary for contrast */
            color: var(--text);
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .input-field {
            background-color: var(--secondary); /* Matte dark gray */
            border-color: #4b5563; /* Subtle border */
            color: var(--text);
        }
        .input-field:focus {
             outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--secondary), 0 0 0 4px var(--accent);
        }
        #loading-spinner, .spinner {
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Update card backgrounds */
        .card-bg {
             background-color: var(--secondary);
        }
        /* Update link colors */
        .link {
            color: var(--accent);
        }
        .link:hover {
            text-decoration: underline;
        }
        /* Update specific UI elements */
        #dashboard-username {
            color: var(--accent);
        }
        #recipient-display {
            color: var(--accent);
        }
        #user-display {
            color: var(--accent);
        }
        .btn-danger {
            background-color: #dc2626; /* red-600 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* red-700 */
        }
        
        /* Presence Indicator Styles */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            transition: background-color 0.3s ease;
        }
        .status-online {
            background-color: #10b981; /* emerald-500 */
        }
        .status-offline {
            background-color: #6b7280; /* gray-500 */
        }
        
        /* Recent Chat Styles */
        .recent-chat-item {
            background-color: #374151; /* gray-700 */
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .recent-chat-item:hover {
            background-color: #4b5563; /* gray-600 */
        }

    </style>
</head>
<body class="h-full flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">
        
        <!-- Loading Screen -->
        <div id="loading-screen" class="flex justify-center items-center h-full">
            <div class="spinner w-12 h-12 border-4 border-gray-600 rounded-full"></div>
        </div>

        <!-- Auth Screen -->
        <div id="auth-screen" class="hidden">
            <div class="card-bg p-8 rounded-lg shadow-2xl">
                <h1 class="text-3xl font-bold text-white mb-6 text-center">Veil</h1>
                <!-- Sign Up Form -->
                <div id="signup-form" class="space-y-4">
                    <h2 class="text-xl text-white font-semibold">Create an Account</h2>
                    <div>
                        <label for="signup-username" class="block text-sm font-medium text-gray-300">Username</label>
                        <input type="text" id="signup-username" class="input-field w-full p-2 mt-1 rounded-md" placeholder="Choose a unique username">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-300">Password</label>
                        <input type="password" id="signup-password" class="input-field w-full p-2 mt-1 rounded-md" placeholder="6+ characters">
                    </div>
                    <button id="signup-btn" class="btn btn-primary w-full py-2 rounded-md font-semibold">Sign Up</button>
                    <p class="text-center text-sm text-gray-400">Already have an account? <a href="#" id="show-login" class="link hover:underline">Log In</a></p>
                </div>
                <!-- Login Form -->
                <div id="login-form" class="hidden space-y-4">
                    <h2 class="text-xl text-white font-semibold">Welcome Back</h2>
                     <div>
                        <label for="login-username" class="block text-sm font-medium text-gray-300">Username</label>
                        <input type="text" id="login-username" class="input-field w-full p-2 mt-1 rounded-md" placeholder="Your username">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-300">Password</label>
                        <input type="password" id="login-password" class="input-field w-full p-2 mt-1 rounded-md" placeholder="Your password">
                    </div>
                    <button id="login-btn" class="btn btn-primary w-full py-2 rounded-md font-semibold">Log In</button>
                    <p class="text-center text-sm text-gray-400">Don't have an account? <a href="#" id="show-signup" class="link hover:underline">Sign Up</a></p>
                </div>
                <div id="auth-error" class="text-red-400 text-sm mt-4 text-center"></div>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="hidden">
             <div class="card-bg p-8 rounded-lg shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-white">Welcome, <span id="dashboard-username"></span></h1>
                        <!-- We still generate the code, but it's just for user ID, not encryption -->
                        <p class="text-gray-400">Your Unique Code (share this with friends): <strong id="dashboard-usercode" class="text-amber-400 font-mono"></strong></p>
                    </div>
                    <button id="logout-btn" class="btn btn-secondary px-4 py-2 rounded-md font-semibold">Logout</button>
                </div>
                <div class="space-y-4">
                     <div>
                        <label for="search-username" class="block text-sm font-medium text-gray-300">Search for a user to chat with</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="text" id="search-username" class="input-field w-full p-2 rounded-md" placeholder="Enter exact username...">
                            <button id="search-btn" class="btn btn-primary px-4 py-2 rounded-md font-semibold">Search</button>
                        </div>
                    </div>
                    <div id="search-results" class="mt-4 text-center"></div>
                </div>
                
                <!-- Recent Chats -->
                <div id="recent-chats-container" class="mt-8">
                    <h3 class="text-lg font-semibold text-white mb-3">Recent Chats</h3>
                    <div id="recent-chats-list" class="space-y-2">
                        <!-- Recent chats will be injected here by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Screen -->
        <div id="chat-screen" class="hidden h-[80vh] flex flex-col">
             <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-xl font-bold text-white">Chat with <span id="recipient-display"></span></h2>
                    <!-- FIX: Added this line back in -->
                    <p class="text-sm text-gray-400">You are <span id="user-display" class="text-accent"></span></p>
                    <div id="online-status-container" class="flex items-center">
                        <span id="online-status-dot" class="status-dot status-offline"></span>
                        <span id="online-status-text" class="text-sm text-gray-400">Offline</span>
                    </div>
                </div>
                <div>
                    <button id="clear-btn" class="btn btn-secondary px-4 py-2 rounded-md font-semibold mr-2">Clear</button>
                    <button id="back-to-dashboard-btn" class="btn btn-danger px-4 py-2 rounded-md font-semibold">Leave</button>
                </div>
            </div>
            <textarea id="chat-box" class="chat-textarea w-full flex-grow p-4 rounded-lg text-lg leading-7 resize-none" spellcheck="false"></textarea>
        </div>

    </div>

    <!-- Custom Code Prompt Modal (NEW) -->
    <div id="code-prompt-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="card-bg p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-semibold text-white mb-2">Enter Unique Code</h2>
            <p class="text-gray-400 mb-4">To start a secure chat with <strong id="prompt-recipient-name" class="text-accent"></strong>, please enter their code.</p>
            <div class="space-y-4">
                <div>
                    <label for="code-prompt-input" class="block text-sm font-medium text-gray-300">Unique Code</label>
                    <input type="text" id="code-prompt-input" class="input-field w-full p-2 mt-1 rounded-md" placeholder="e.g., alpha-1234">
                </div>
                <div id="code-prompt-error" class="text-red-400 text-sm text-center"></div>
                <div class="flex justify-end space-x-3">
                    <button id="code-prompt-cancel" class="btn btn-secondary px-4 py-2 rounded-md font-semibold">Cancel</button>
                    <button id="code-prompt-confirm" class="btn btn-primary px-4 py-2 rounded-md font-semibold">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, query, where, getDocs, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // ----------------------------------------------------------------------
        // PASTE YOUR FIREBASE CONFIG HERE
        // 1. Go to your Firebase project settings
        // 2. Under "Your apps", copy the 'firebaseConfig' object
        // 3. Paste it directly below, replacing the placeholder object
        // ----------------------------------------------------------------------
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // --- YOUR CONFIG HAS BEEN PASTED HERE ---
            apiKey: "AIzaSyAO6sKjbBKdWm3MXggc-Iliywxh7CwSKok",
            authDomain: "capsc-d160e.firebaseapp.com",
            projectId: "capsc-d160e",
            storageBucket: "capsc-d160e.firebasestorage.app",
            messagingSenderId: "1069210585933",
            appId: "1:1069210585933:web:54f05cf195caeea8320504"
            // measurementId is optional and not used in this app
            // ------------------------------------------
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- App State ---
        let db, auth, currentRoomId, currentUser = null;
        let cryptoKey; // Re-added for E2EE
        let unsubscribeRoom = () => {};
        let unsubscribePresence = () => {}; // For presence listener
        let currentRecipient = null; // Store recipient data
        let isUpdatingFromFirestore = false;
        
        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const signupForm = document.getElementById('signup-form');
        const loginForm = document.getElementById('login-form');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const chatScreen = document.getElementById('chat-screen');
        const onlineStatusDot = document.getElementById('online-status-dot');
        const onlineStatusText = document.getElementById('online-status-text');
        
        // NEW Modal Elements
        const codePromptModal = document.getElementById('code-prompt-modal');
        const codePromptRecipientName = document.getElementById('prompt-recipient-name');
        const codePromptInput = document.getElementById('code-prompt-input');
        const codePromptError = document.getElementById('code-prompt-error');
        const codePromptCancel = document.getElementById('code-prompt-cancel');
        const codePromptConfirm = document.getElementById('code-prompt-confirm');


        // --- Init ---
        async function init() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setupEventListeners();
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userProfile = await getUserProfile(user.uid);
                    if (userProfile) {
                        currentUser = { uid: user.uid, ...userProfile };
                        showDashboard();
                    } else {
                        // This can happen if auth succeeds but firestore profile is missing
                        // Forcing logout to prevent app from getting stuck
                        console.warn("User authenticated but profile data is missing. Logging out.");
                        signOut(auth);
                    }
                } else {
                    currentUser = null;
                    showAuthScreen();
                }
                loadingScreen.classList.add('hidden');
            });

            // Add listener to remove presence on tab close
            window.addEventListener('beforeunload', () => {
                if (currentUser && currentRoomId) {
                    removePresence(currentUser.uid);
                }
            });
        }
        
        // --- UI Control ---
        function showAuthScreen() {
            authScreen.classList.remove('hidden');
            dashboardScreen.classList.add('hidden');
            chatScreen.classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('dashboard-username').textContent = currentUser.username;
            document.getElementById('dashboard-usercode').textContent = currentUser.uniqueCode;
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('search-username').value = '';
            
            displayRecentChats(); // <-- ADDED: Load recent chats
            
            authScreen.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');
            chatScreen.classList.add('hidden');
        }

        function showChatScreen(yourUsername, recipientUsername) {
            document.getElementById('user-display').textContent = yourUsername;
            document.getElementById('recipient-display').textContent = recipientUsername;
            authScreen.classList.add('hidden');
            dashboardScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            document.getElementById('chat-box').focus();
        }

        // NEW function: Replaces the native prompt()
        function showCodePrompt(recipient) {
            return new Promise((resolve, reject) => {
                codePromptRecipientName.textContent = recipient.username;
                codePromptInput.value = '';
                codePromptError.textContent = '';
                codePromptModal.classList.remove('hidden');
                codePromptInput.focus();

                // --- Create one-time event handlers ---
                const handleConfirm = () => {
                    const code = codePromptInput.value.trim();
                    if (!code) {
                        codePromptError.textContent = 'Please enter a code.';
                        return; // Don't close modal
                    }
                    cleanup();
                    resolve(code);
                };

                const handleCancel = () => {
                    cleanup();
                    reject(new Error('User cancelled prompt.'));
                };

                const handleKeyup = (e) => {
                    if (e.key === 'Enter') handleConfirm();
                    if (e.key === 'Escape') handleCancel();
                };

                // --- Add event listeners ---
                codePromptConfirm.addEventListener('click', handleConfirm);
                codePromptCancel.addEventListener('click', handleCancel);
                codePromptInput.addEventListener('keyup', handleKeyup);
                
                // --- Cleanup function to remove listeners and hide modal ---
                function cleanup() {
                    codePromptConfirm.removeEventListener('click', handleConfirm);
                    codePromptCancel.removeEventListener('click', handleCancel);
                    codePromptInput.removeEventListener('keyup', handleKeyup);
                    codePromptModal.classList.add('hidden');
                }
            });
        }

        // --- Crypto Helper Functions (Re-added) ---
        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const baseKey = await window.crypto.subtle.importKey(
                "raw",
                encoder.encode(password),
                // FIX: Was "PBK2", corrected to "PBKDF2"
                { name: "PBKDF2" },
                false,
                ["deriveKey"]
            );
            return await window.crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: encoder.encode(salt),
                    iterations: 100000,
                    hash: "SHA-256",
                },
                baseKey,
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt", "decrypt"]
            );
        }

        async function encryptText(text, key) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encodedText = new TextEncoder().encode(text);
            const encryptedData = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                key,
                encodedText
            );
            
            const encryptedArray = new Uint8Array(iv.length + encryptedData.byteLength);
            encryptedArray.set(iv);
            encryptedArray.set(new Uint8Array(encryptedData), iv.length);

            return btoa(String.fromCharCode.apply(null, encryptedArray));
        }

        async function decryptText(encryptedBase64, key) {
            try {
                const encryptedArray = new Uint8Array(atob(encryptedBase64).split("").map(c => c.charCodeAt(0)));
                const iv = encryptedArray.slice(0, 12);
                const data = encryptedArray.slice(12);

                const decryptedData = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    data
                );

                return new TextDecoder().decode(decryptedData);
            } catch (error) {
                console.error("Decryption failed:", error);
                return "DECRYPTION FAILED: Invalid unique code for this user.";
            }
        }
        
        // --- Auth & User Profile Functions ---
        async function getUserProfile(uid) {
            // Corrected: Directly get the document by its ID (which is the uid)
            const userRef = doc(db, `/artifacts/${appId}/public/data/users`, uid);
            const docSnap = await getDoc(userRef); // Use getDoc, not getDocs
            if (docSnap.exists()) {
                return docSnap.data();
            }
            return null;
        }

        async function findUserByUsername(username) {
            const usersRef = collection(db, `/artifacts/${appId}/public/data/users`);
            const q = query(usersRef, where("username", "==", username));
            const querySnapshot = await getDocs(q);
            return querySnapshot;
        }

        function generateUniqueCode() {
            const words = ['alpha', 'beta', 'gamma', 'delta', 'omega', 'zeta', 'nova', 'comet', 'orbit', 'pulse'];
            return `${words[Math.floor(Math.random() * words.length)]}-${Math.floor(1000 + Math.random() * 9000)}`;
        }

        // --- Event Handlers ---
        function setupEventListeners() {
            // Auth screen toggles
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });

            // Auth buttons
            document.getElementById('signup-btn').addEventListener('click', handleSignUp);
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

            // Dashboard
            document.getElementById('search-btn').addEventListener('click', handleSearch);
            
            // Chat
            document.getElementById('back-to-dashboard-btn').addEventListener('click', handleLeaveChat);
            // MODIFIED: Call deleteRoomContent instead of updateFirestoreContent
            document.getElementById('clear-btn').addEventListener('click', () => deleteRoomContent());
            document.getElementById('chat-box').addEventListener('input', () => { if (!isUpdatingFromFirestore) { updateFirestoreContent(document.getElementById('chat-box').value); }});
        }

        async function handleSignUp() {
            const username = document.getElementById('signup-username').value.trim().toLowerCase();
            const password = document.getElementById('signup-password').value.trim();
            const errorEl = document.getElementById('auth-error');
            errorEl.textContent = '';

            if (!username || password.length < 6) {
                errorEl.textContent = 'Username is required and password must be 6+ characters.';
                return;
            }

            const existingUsers = await findUserByUsername(username);
            if (!existingUsers.empty) {
                errorEl.textContent = 'Username is already taken.';
                return;

            }
            
            try {
                // We create a dummy email for Firebase Auth, as it requires it
                const dummyEmail = `${username}@e2ee-chat.app`;
                const userCredential = await createUserWithEmailAndPassword(auth, dummyEmail, password);
                const user = userCredential.user;

                // We store the *real* username and our code in Firestore
                const userProfile = {
                    uid: user.uid,
                    username: username,
                    uniqueCode: generateUniqueCode()
                };
                await setDoc(doc(db, `/artifacts/${appId}/public/data/users`, user.uid), userProfile);
                // Auth state change will now handle showing the dashboard

            } catch (error) {
                errorEl.textContent = 'Error creating account: ' + error.message;
            }
        }
        
        async function handleLogin() {
            const username = document.getElementById('login-username').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value.trim();
            const errorEl = document.getElementById('auth-error');
            errorEl.textContent = '';

            if (!username || !password) {
                errorEl.textContent = 'Please enter username and password.';
                return;
            }

            try {
                // Use the same dummy email convention to log in
                const dummyEmail = `${username}@e2ee-chat.app`;
                await signInWithEmailAndPassword(auth, dummyEmail, password);
                // Auth state change will now handle showing the dashboard
            } catch (error) {
                errorEl.textContent = 'Invalid username or password.';
            }
        }

        async function handleSearch() {
            const searchUsername = document.getElementById('search-username').value.trim().toLowerCase();
            const resultsEl = document.getElementById('search-results');
            resultsEl.innerHTML = '<div class="spinner w-6 h-6 border-2 border-gray-600 rounded-full mx-auto"></div>';

            if (!searchUsername) {
                resultsEl.innerHTML = '<p class="text-gray-400">Please enter a username to search.</p>';
                return;
            }
            if (searchUsername === currentUser.username) {
                resultsEl.innerHTML = '<p class="text-amber-400">You can\'t chat with yourself!</p>';
                return;
            }

            const querySnapshot = await findUserByUsername(searchUsername);
            if (querySnapshot.empty) {
                resultsEl.innerHTML = '<p class="text-red-400">User not found.</p>';
            } else {
                const recipient = querySnapshot.docs[0].data();
                resultsEl.innerHTML = `
                    <div class="bg-gray-700 p-4 rounded-md flex justify-between items-center">
                        <span class="font-semibold text-white">${recipient.username}</span>
                        <button id="initiate-chat-btn" class="btn btn-primary px-3 py-1 rounded-md text-sm">Chat</button>
                    </div>
                `;
                document.getElementById('initiate-chat-btn').addEventListener('click', () => handleInitiateChat(recipient));
            }
        }
        
        // MODIFIED: To accept an optional pre-filled secret
        async function handleInitiateChat(recipient, optionalSecret = null) {
            const resultsEl = document.getElementById('search-results');
            let secret = optionalSecret;

            // If no secret was provided (not a recent chat), prompt the user
            if (!secret) {
                // --- MODIFIED: Replaced prompt() with custom modal ---
                try {
                    secret = await showCodePrompt(recipient);
                } catch (error) {
                    // User clicked cancel
                    resultsEl.innerHTML = `<p class="text-red-400">Chat cancelled.</p>`;
                    return;
                }
                // --- End of modification ---
            }

            // Create a deterministic, sorted room ID
            const codes = [currentUser.username, recipient.username].sort();
            currentRoomId = codes.join('-');
            currentRecipient = recipient; // <-- ADDED: Store recipient

            try {
                // ADDED: Derive the encryption key
                cryptoKey = await deriveKey(secret, currentRoomId);
                
                // --- ADDED: PRESENCE & RECENTS ---
                // 1. Save this chat to recents
                saveRecentChat(recipient, secret);
                // 2. Set our own presence
                setPresence(currentUser.uid);
                // 3. Listen for their presence
                listenForPresence(recipient.uid);
                // ---------------------------------
                
                listenToRoom();
                showChatScreen(currentUser.username, recipient.username);

            } catch (error) {
                console.error("Error starting chat:", error);
                // MODIFIED: Better error handling
                if (error.message === 'User cancelled prompt.') {
                    resultsEl.innerHTML = `<p class="text-red-400">Chat cancelled.</p>`;
                } else if (optionalSecret) {
                    // This was a "Recent Chat" click and it failed.
                    resultsEl.innerHTML = `<p class="text-red-400">The saved code for this user is incorrect. It's been removed. Please search for them again.</p>`;
                    deleteRecentChat(recipient.uid); // Delete the bad recent chat
                } else {
                    // This was a manual search and the code was wrong.
                    resultsEl.innerHTML = `<p class="text-red-400">Could not start chat. The code you entered is incorrect.</p>`;
                }
            }
        }

        // --- Recent Chats Functions (NEW) ---
        function getRecentChats() {
            const chats = localStorage.getItem('recentChats');
            return chats ? JSON.parse(chats) : [];
        }

        function saveRecentChat(recipient, secret) {
            let chats = getRecentChats();
            // Remove old entry for this user, if any
            chats = chats.filter(chat => chat.uid !== recipient.uid);
            // Add new entry to the top
            chats.unshift({
                uid: recipient.uid,
                username: recipient.username,
                secret: secret // Store the secret for re-use
            });
            // Keep only the last 5 recents
            chats = chats.slice(0, 5);
            localStorage.setItem('recentChats', JSON.stringify(chats));
        }

        // NEW function to remove a single recent chat
        function deleteRecentChat(uid) {
            let chats = getRecentChats();
            chats = chats.filter(chat => chat.uid !== uid);
            localStorage.setItem('recentChats', JSON.stringify(chats));
            displayRecentChats(); // Refresh the list
        }

        function displayRecentChats() {
            const chats = getRecentChats();
            const listEl = document.getElementById('recent-chats-list');
            if (chats.length === 0) {
                listEl.innerHTML = '<p class="text-sm text-gray-500 text-center">No recent chats.</p>';
                return;
            }
            listEl.innerHTML = chats.map(chat => `
                <div class="recent-chat-item" data-uid="${chat.uid}">
                    <span class="font-semibold text-white">${chat.username}</span>
                    <button class="btn btn-primary px-3 py-1 rounded-md text-sm" data-secret="${chat.secret}">Chat</button>
                </div>
            `).join('');

            // Add event listeners to the new buttons
            listEl.querySelectorAll('.recent-chat-item button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent clicks from bubbling
                    const secret = e.target.dataset.secret;
                    const username = e.target.previousElementSibling.textContent;
                    const uid = e.target.parentElement.dataset.uid;
                    // Re-create the recipient object and call handleInitiateChat
                    handleInitiateChat({ uid, username }, secret);
                });
            });
        }

        // --- Presence Functions (NEW) ---
        function getPresenceCollectionPath() {
            if (!currentRoomId) return null;
            return `/artifacts/${appId}/public/data/presence/${currentRoomId}/users`;
        }

        async function setPresence(userId) {
            const path = getPresenceCollectionPath();
            if (!path) return;
            try {
                await setDoc(doc(db, path, userId), { online: true, timestamp: new Date() });
            } catch (error) {
                console.error("Error setting presence:", error);
            }
        }

        async function removePresence(userId) {
            const path = getPresenceCollectionPath();
            if (!path) return;
            try {
                await deleteDoc(doc(db, path, userId));
            } catch (error) {
                console.error("Error removing presence:", error);
            }
        }

        function listenForPresence(recipientUid) {
            const path = getPresenceCollectionPath();
            if (!path) return;
            
            const recipientDocRef = doc(db, path, recipientUid);
            unsubscribePresence = onSnapshot(recipientDocRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().online) {
                    onlineStatusDot.classList.remove('status-offline');
                    onlineStatusDot.classList.add('status-online');
                    onlineStatusText.textContent = "Online";
                } else {
                    onlineStatusDot.classList.remove('status-online');
                    onlineStatusDot.classList.add('status-offline');
                    onlineStatusText.textContent = "Offline";
                }
            });
        }


        // NEW function: Deletes the chat document from Firestore
        async function deleteRoomContent() {
            if (!currentRoomId) return;
            const roomRef = doc(db, `/artifacts/${appId}/public/data/e2ee-chat`, currentRoomId);
            try {
                // This permanently deletes the document
                await deleteDoc(roomRef);
            } catch (error) {
                console.error("Error deleting document:", error);
            }
        }

// This function is called by 'Clear' and 'Leave'
        function handleLeaveChat() {
            if (unsubscribeRoom) unsubscribeRoom();
            if (unsubscribePresence) unsubscribePresence(); // <-- ADDED: Stop presence listener
            
            // ADDED: Delete the room content when leaving
            deleteRoomContent(); 
            // ADDED: Remove our own presence
            if (currentUser) {
                removePresence(currentUser.uid);
            }

            currentRoomId = null;
            cryptoKey = null; // Added
            currentRecipient = null; // Added
            document.getElementById('chat-box').value = "";
            showDashboard();
        }

        // --- Firestore Real-time (Now E2EE) ---
        async function updateFirestoreContent(content) {
            if (!currentRoomId || !cryptoKey) return; // Added cryptoKey check
            // Storing content WITH encryption
            const encryptedContent = await encryptText(content, cryptoKey);
            const roomRef = doc(db, `/artifacts/${appId}/public/data/e2ee-chat`, currentRoomId);
            await setDoc(roomRef, { content: encryptedContent }, { merge: true });
        }
        
        function listenToRoom() {
            const roomRef = doc(db, `/artifacts/${appId}/public/data/e2ee-chat`, currentRoomId);
            unsubscribeRoom = onSnapshot(roomRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.content !== undefined) { // Check for undefined, as empty string is valid
                        // Decrypt the content
                        const decryptedContent = await decryptText(data.content, cryptoKey);
                        isUpdatingFromFirestore = true;
                        if(document.getElementById('chat-box').value !== decryptedContent) {
                             document.getElementById('chat-box').value = decryptedContent;
                        }
                        isUpdatingFromFirestore = false;
                    }
                } else {
                    // MODIFIED: The document was deleted (by "Clear" or "Leave"). 
                    // Just clear the local text area. Do NOT re-create the document here.
                    isUpdatingFromFirestore = true;
                    if(document.getElementById('chat-box').value !== "") {
                         document.getElementById('chat-box').value = "";
                    }
                    isUpdatingFromFirestore = false;
                }
            });
        }

        // Start the app
        init();
    </script>
</body>
</html>




